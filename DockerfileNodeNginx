FROM node:8.15.0 as builder


WORKDIR /code

# And npm packages
COPY package.json .
COPY yarn.lock .
RUN yarn install

# Set up the files to build with
COPY build ./build
COPY static ./static
COPY assets ./assets
COPY .eslintrc.js .

# COPY in the project files
COPY src ./src
COPY index.html .

# We need some build environment variables to switch settings with
ARG API_HOST
ARG WEB_HOST
ARG ENVIRONMENT

RUN yarn build

# In the case of dev, we repopulate the $APPDIR directory and run
# from there with live sources. Since this is a staged build, we only
# build up to here too... the nginx bits below are for production.

FROM nginx:1.13.9 as nginx

# Set up Nginx
COPY build/nginx-www.conf /etc/nginx/nginx.conf
COPY build/nginx-www-default.conf /etc/nginx/conf.d/default.conf
COPY index.html /etc/nginx/conf.d/

COPY --from=builder /code/dist /tmp/dist
RUN rm -rf /usr/share/nginx/html && mv /tmp/dist /usr/share/nginx/html
