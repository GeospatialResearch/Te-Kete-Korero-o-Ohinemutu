version: "3.4"
volumes:
  staticfiles:
  media:
  geoserver-data:
  db-data:
services:
  db:
    image: mdillon/postgis:9.6
    restart: always
    env_file: .dockerenv
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - '5432:5432'

  geoserver:
    image: geospatialri/geoserver-postgis:2.15.0
    restart: always
    env_file: .dockerenv
    environment:
      - VIRTUAL_HOST=geoserver.maptool.test.geospatial.ac.nz
      - LETSENCRYPT_HOST=geoserver.maptool.test.geospatial.ac.nz
      - LETSENCRYPT_EMAIL=geospatial.gri@gmail.com
    depends_on:
      - 'db'
    volumes:
      - geoserver-data:/opt/geoserver/data_dir

  api:
    image: geospatialri/bicultool-django:develop
    restart: always
    env_file: .dockerenv
    environment:
      - EMAIL_PASS=$EMAIL_PASSWORD
    depends_on:
      - 'db'
    ports:
      - 8000
    volumes:
      - staticfiles:/code/staticfiles
      - media:/code/media

  www:
    image: geospatialri/bicultool:develop
    restart: always
    environment:
      - VIRTUAL_HOST=www.maptool.test.geospatial.ac.nz
      - LETSENCRYPT_HOST=www.maptool.test.geospatial.ac.nz
      - LETSENCRYPT_EMAIL=geospatial.gri@gmail.com
    ports:
      - "80:80"

  api-nginx:
    image: geospatialri/bicultool-django-nginx:develop
    restart: always
    environment:
      - VIRTUAL_HOST=api.maptool.test.geospatial.ac.nz
      - LETSENCRYPT_HOST=api.maptool.test.geospatial.ac.nz
      - LETSENCRYPT_EMAIL=geospatial.gri@gmail.com
    depends_on:
      - 'api'
    volumes:
      - staticfiles:/code/staticfiles
      - media:/code/media
